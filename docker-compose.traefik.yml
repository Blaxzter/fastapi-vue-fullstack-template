networks:
    # Use the public network "traefik-net", shared with other
    # services that need to be publicly available via this Traefik
    traefik-net:
        name: traefik-net

services:
    traefik:
        image: traefik:v3.6
        container_name: traefik
        ports:
            # Listen on port 80, default for HTTP, necessary to redirect to HTTPS
            - "80:80"
            # Listen on port 443, default for HTTPS
            - "443:443"
        restart: unless-stopped
        labels:
            # Enable Traefik for this service, to make it available in the public network
            - traefik.enable=true
            # Make Traefik use this domain (from an environment variable)
            - traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN?Variable not set}`)
            # Use the "websecure" entrypoint for HTTPS
            - traefik.http.routers.dashboard.entrypoints=websecure
            # Use the "letsencrypt" resolver for TLS certificates
            - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
            # Use the special Traefik service api@internal with the web UI/Dashboard
            - traefik.http.routers.dashboard.service=api@internal
            # admin-auth middleware with HTTP Basic auth
            # Using the environment variables USERNAME and HASHED_PASSWORD
            - traefik.http.middlewares.dashboard-auth.basicauth.users=${USERNAME?Variable not set}:${HASHED_PASSWORD?Variable not set}
            # Enable HTTP Basic auth, using the middleware created above
            - traefik.http.routers.dashboard.middlewares=dashboard-auth
        volumes:
            # Add Docker as a mounted volume, so that Traefik can read the labels of other services
            - /var/run/docker.sock:/var/run/docker.sock:ro
            # Mount the volume to store the certificates
            - ./letsencrypt:/letsencrypt
        command:
            # Enable Docker in Traefik, so that it reads labels from Docker services
            - --providers.docker=true
            # Do not expose all Docker services, only the ones explicitly exposed
            - --providers.docker.exposedbydefault=false
            # Ensure Traefik uses the traefik-net network to reach containers
            - --providers.docker.network=traefik-net
            # Create an entrypoint "web" listening on port 80
            - --entrypoints.web.address=:80
            # Create an entrypoint "websecure" listening on port 443
            - --entrypoints.websecure.address=:443
            # Global HTTP â†’ HTTPS redirect at the entrypoint level
            - --entrypoints.web.http.redirections.entrypoint.to=websecure
            - --entrypoints.web.http.redirections.entrypoint.scheme=https
            # Create the certificate resolver "letsencrypt" for Let's Encrypt, uses the environment variable EMAIL
            - --certificatesresolvers.letsencrypt.acme.email=${EMAIL?Variable not set}
            # Store the Let's Encrypt certificates in the mounted volume
            - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
            # Use the HTTP Challenge for Let's Encrypt
            - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
            # Enable the Dashboard and API
            - --api.dashboard=true
            # Enable the Traefik log, for configurations and errors
            - --log.level=WARN
            # Enable the access log, with HTTP requests
            - --accesslog=true
        networks:
            # Use the public network created to be shared between Traefik and
            # any other service that needs to be publicly available with HTTPS
            - traefik-net
